{% extends "base.html" %}

{% block title %}Resultados del Entrenamiento - Clasificación{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/model_training_hub.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">
                Resultados de Clasificación
            </h1>
            <p class="text-center text-muted mb-5">
                Análisis completo del modelo {{ model_info.model_type|title|replace('_', ' ') }}
            </p>
        </div>
    </div>

    <!-- Información del modelo -->
    <div class="data-info-card mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5>Información del Modelo</h5>
                <p class="mb-0">
                    <strong>Modelo:</strong> {{ model_info.model_type|title|replace('_', ' ') }}<br>
                    <strong>Archivo:</strong> {{ model_info.file_used }}<br>
                    <strong>Variable Target:</strong> {{ model_info.target_column }} | 
                    <strong>Clases:</strong> {{ model_info.n_classes }}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
            </div>
        </div>
    </div>

    <!-- Advertencias de preprocesamiento -->
    {% if model_info.classes_removed %}
    <div class="alert alert-warning mb-4" role="alert">
        <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Clases minoritarias removidas</h5>
        <p class="mb-2">Se removieron clases con muy pocas muestras para permitir el entrenamiento del modelo:</p>
        <ul class="mb-2">
            {% for class_name in model_info.classes_removed %}
            <li><code>{{ class_name }}</code></li>
            {% endfor %}
        </ul>
        <hr>
        <p class="mb-0"><strong>Datos utilizados:</strong> {{ model_info.train_size + model_info.test_size }} muestras de las {{ model_info.original_samples }} originales ({{ model_info.n_classes }} clases de {{ model_info.original_classes }} originales)</p>
    </div>
    {% endif %}

    <!-- Métricas principales -->
    <div class="model-section mb-4">
        <h2 class="section-title">
            Métricas de Rendimiento
        </h2>
        <p class="section-description">
            Evaluación del rendimiento del modelo entrenado
        </p>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="metric-card">
                    <div class="metric-value text-success">{{ "%.1f%%" | format(main_metrics.test_accuracy * 100) }}</div>
                    <div class="metric-label text-center" data-bs-toggle="tooltip" 
                         data-bs-placement="top" 
                         data-bs-html="true"
                         title="<strong>Precisión en Prueba (Accuracy)</strong><br>• Porcentaje de predicciones correctas en datos de prueba<br>• Accuracy = (TP + TN) / Total<br>• Métrica principal para evaluar el rendimiento<br>• 100% = todas las predicciones correctas<br>• 50% = tan bueno como azar (para 2 clases)"
                         style="cursor: help;">
                        Precisión en Prueba
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-card">
                    <div class="metric-value text-primary">{{ "%.1f%%" | format(main_metrics.train_accuracy * 100) }}</div>
                    <div class="metric-label text-center" data-bs-toggle="tooltip" 
                         data-bs-placement="top" 
                         data-bs-html="true"
                         title="<strong>Precisión Entrenamiento</strong><br>• Accuracy en datos de entrenamiento<br>• Si es mucho mayor que precisión de prueba, hay overfitting<br>• Ideal: valores similares entre entrenamiento y prueba<br>• Diferencia >10% puede indicar sobreajuste"
                         style="cursor: help;">
                        Precisión Entrenamiento
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="metric-card">
                    <div class="metric-value text-info">{{ "%.3f" | format(main_metrics.test_precision_macro) }}</div>
                    <div class="metric-label text-center" data-bs-toggle="tooltip" 
                         data-bs-placement="top" 
                         data-bs-html="true"
                         title="<strong>Precisión (Precision)</strong><br>• De las predicciones positivas, cuántas fueron correctas<br>• Precision = TP / (TP + FP)<br>• 1.0 = no hay falsos positivos<br>• 0.0 = todas las predicciones positivas fueron incorrectas<br>• Importante cuando el costo de falsos positivos es alto"
                         style="cursor: help;">
                        Precisión
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="metric-card">
                    <div class="metric-value text-warning">{{ "%.3f" | format(main_metrics.test_recall_macro) }}</div>
                    <div class="metric-label text-center" data-bs-toggle="tooltip" 
                         data-bs-placement="top" 
                         data-bs-html="true"
                         title="<strong>Recall (Sensibilidad)</strong><br>• De los casos positivos reales, cuántos fueron detectados<br>• Recall = TP / (TP + FN)<br>• 1.0 = se detectaron todos los casos positivos<br>• 0.0 = no se detectó ningún caso positivo<br>• Importante cuando el costo de falsos negativos es alto"
                         style="cursor: help;">
                        Recall
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="metric-card">
                    <div class="metric-value text-danger">{{ "%.3f" | format(main_metrics.test_f1_macro) }}</div>
                    <div class="metric-label text-center" data-bs-toggle="tooltip" 
                         data-bs-placement="top" 
                         data-bs-html="true"
                         title="<strong>F1-Score</strong><br>• Media armónica entre Precisión y Recall<br>• F1 = 2 * (Precision * Recall) / (Precision + Recall)<br>• Equilibra precisión y recall en una sola métrica<br>• 1.0 = modelo perfecto<br>• 0.0 = modelo completamente inútil<br>• Útil cuando hay desbalance de clases"
                         style="cursor: help;">
                        F1-Score
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalles del modelo -->
    <div class="model-section mb-4">
        <h2 class="section-title">
            Detalles del Modelo
        </h2>
        <p class="section-description">
            Configuración y variables utilizadas en el entrenamiento
        </p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="model-card">
                    <h6 class="text-primary mb-3">Configuración del Modelo</h6>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2"><strong class="text-dark">Tipo de Modelo:</strong> <span class="badge bg-primary">{{ model_info.model_type|title|replace('_', ' ') }}</span></li>
                        <li class="mb-2"><strong class="text-dark">Archivo Usado:</strong> <span class="badge bg-secondary">{{ model_info.file_used }}</span></li>
                        <li class="mb-2"><strong class="text-dark">Variable Target:</strong> <span class="badge bg-success">{{ model_info.target_column }}</span></li>
                        <li class="mb-2"><strong class="text-dark">Número de Clases:</strong> <span class="badge bg-info">{{ model_info.n_classes }}</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="model-card">
                    <h6 class="text-success mb-3">Variables Predictoras</h6>
                    <div class="features-container" style="max-height: 150px; overflow-y: auto;">
                        <div class="d-flex flex-wrap gap-1">
                            {% for feature in model_info.feature_columns %}
                            <span class="badge bg-dark text-light">{{ feature }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Matriz de confusión -->
    {% if confusion_matrix %}
    <div class="model-section">
        <h2 class="section-title" data-bs-toggle="tooltip" 
           data-bs-placement="top" 
           data-bs-html="true"
           title="<strong>Matriz de Confusión</strong><br>• Tabla que muestra predicciones vs. valores reales<br>• Diagonal = predicciones correctas<br>• Fuera de diagonal = errores<br>• Permite identificar qué clases se confunden entre sí<br>• Ideal: valores altos en diagonal, bajos fuera"
           style="cursor: help;">
            Matriz de Confusión
        </h2>
        <p class="section-description">
            Análisis detallado de predicciones correctas e incorrectas
        </p>
        
        <div class="info-card">
            <div class="table-responsive">
                <table class="table table-bordered table-sm text-center">
                    <thead class="table-dark">
                        <tr>
                            <th>Predicho/Real</th>
                            {% for i in range(confusion_matrix|length) %}
                            <th>Clase {{ i }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in confusion_matrix %}
                        {% set row_index = loop.index0 %}
                        <tr>
                            <td class="table-dark"><strong>Clase {{ row_index }}</strong></td>
                            {% for value in row %}
                            <td class="{% if loop.index0 == row_index %}table-success{% else %}table-light{% endif %}">
                                {{ value }}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <small class="text-muted">
                Los valores en la diagonal (verde) representan predicciones correctas
            </small>
        </div>
    </div>
    {% endif %}

    <!-- Reporte detallado -->
    {% if classification_report %}
    <div class="model-section">
        <h2 class="section-title">
            Reporte Detallado por Clase
        </h2>
        <p class="section-description">
            Métricas específicas para cada clase del modelo
        </p>
        
        <div class="info-card">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Clase</th>
                            <th data-bs-toggle="tooltip" 
                                data-bs-placement="top" 
                                data-bs-html="true"
                                title="<strong>Precisión por Clase</strong><br>• TP / (TP + FP)<br>• De las predicciones de esta clase, cuántas fueron correctas<br>• Alta precisión = pocos falsos positivos"
                                style="cursor: help;">Precisión</th>
                            <th data-bs-toggle="tooltip" 
                                data-bs-placement="top" 
                                data-bs-html="true"
                                title="<strong>Recall por Clase</strong><br>• TP / (TP + FN)<br>• De los casos reales de esta clase, cuántos fueron detectados<br>• Alto recall = pocos falsos negativos"
                                style="cursor: help;">Recall</th>
                            <th data-bs-toggle="tooltip" 
                                data-bs-placement="top" 
                                data-bs-html="true"
                                title="<strong>F1-Score por Clase</strong><br>• Media armónica de Precisión y Recall<br>• Equilibra ambas métricas<br>• Útil para comparar rendimiento entre clases"
                                style="cursor: help;">F1-Score</th>
                            <th data-bs-toggle="tooltip" 
                                data-bs-placement="top" 
                                data-bs-html="true"
                                title="<strong>Soporte</strong><br>• Número de muestras reales de esta clase en el conjunto de prueba<br>• Indica qué tan representada está cada clase<br>• Clases con poco soporte pueden tener métricas menos confiables"
                                style="cursor: help;">Soporte</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for class_name, metrics in classification_report.items() %}
                        {% if class_name not in ['accuracy', 'macro avg', 'weighted avg'] and metrics is mapping %}
                        <tr>
                            <td><span class="badge bg-primary">{{ class_name }}</span></td>
                            <td>{{ "%.3f" | format(metrics.precision) }}</td>
                            <td>{{ "%.3f" | format(metrics.recall) }}</td>
                            <td>{{ "%.3f" | format(metrics['f1-score']) }}</td>
                            <td>{{ metrics.support }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        
                        <!-- Separador -->
                        <tr><td colspan="5"><hr></td></tr>
                        
                        <!-- Promedios -->
                        {% for avg_type in ['macro avg', 'weighted avg'] %}
                        {% if avg_type in classification_report %}
                        <tr class="table-secondary">
                            <td><strong>{{ avg_type|title }}</strong></td>
                            <td><strong>{{ "%.3f" | format(classification_report[avg_type].precision) }}</strong></td>
                            <td><strong>{{ "%.3f" | format(classification_report[avg_type].recall) }}</strong></td>
                            <td><strong>{{ "%.3f" | format(classification_report[avg_type]['f1-score']) }}</strong></td>
                            <td><strong>{{ classification_report[avg_type].support }}</strong></td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Información de preparación -->
    {% if preparation_info %}
    <div class="model-section">
        <h2 class="section-title">
            Información de Preparación de Datos
        </h2>
        <p class="section-description">
            Detalles sobre el procesamiento y preparación de los datos
        </p>
        
        <div class="row">
            <div class="col-md-12">
                <div class="info-card">
                    <h6>Configuración del Modelo</h6>
                    <ul class="list-unstyled mb-0">
                        <li><strong>Número de características:</strong> {{ preparation_info.features_count }}</li>
                        <li><strong>Valores únicos en target:</strong> {{ preparation_info.target_unique_values }}</li>
                        <li><strong>Tipo de target:</strong> {{ preparation_info.target_type }}</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Gráfico de Distribución del Target -->
        {% if preparation_info and preparation_info.target_distribution %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="info-card">
                    <h6>Distribución de la Variable Target: {{ model_info.target_column }}</h6>
                    <div class="chart-container" style="position: relative; height: 400px; margin-top: 20px;">
                        <canvas id="targetDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Botones de acción -->
    <div class="text-center mt-5 mb-5">
        <div class="d-flex justify-content-center gap-3 flex-wrap">
            <a href="{{ url_for('training.sklearn_classification') }}" class="btn btn-warning btn-lg px-4 text-white">
                Entrenar Otro Modelo
            </a>
            <a href="{{ url_for('training.training') }}" class="btn btn-primary btn-lg px-4">
                Hub de Entrenamiento
            </a>
            <button class="btn btn-success btn-lg px-4" data-bs-toggle="modal" data-bs-target="#saveModelModal">
                Guardar Modelo
            </button>
        </div>
    </div>

    <!-- Modal para guardar modelo -->
    <div class="modal fade" id="saveModelModal" tabindex="-1" aria-labelledby="saveModelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveModelModalLabel">
                        Guardar Modelo de Clasificación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('training.save_model') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="model_name" class="form-label">Nombre del Modelo</label>
                            <input type="text" class="form-control" id="model_name" name="model_name" 
                                   placeholder="Ejemplo: mi_clasificador_decision_tree" 
                                   value="{{ model_info.model_type }}_clasificacion">
                            <div class="form-text">
                                Deja en blanco para generar un nombre automático con timestamp
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Información del Modelo</h6>
                            <ul class="mb-0">
                                <li><strong>Tipo:</strong> {{ model_info.model_type|title|replace('_', ' ') }}</li>
                                <li><strong>Variable Target:</strong> {{ model_info.target_column }}</li>
                                <li><strong>Características:</strong> {{ model_info.feature_columns|length }}</li>
                                <li><strong>Accuracy de Test:</strong> {{ "%.3f"|format(main_metrics.test_accuracy) }}</li>
                            </ul>
                        </div>
                        
                        <!-- Campos ocultos -->
                        <input type="hidden" name="model_type" value="{{ model_info.model_type }}">
                        <input type="hidden" name="task_type" value="classification">
                        <input type="hidden" name="results_id" value="{{ request.args.get('results_id', '') }}">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">
                            Guardar Modelo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Inicializar tooltips de Bootstrap
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            html: true,
            delay: { "show": 300, "hide": 100 }
        });
    });
    
    // Generar gráfico de distribución del target
    {% if preparation_info and preparation_info.target_distribution %}
    const targetDistribution = {{ preparation_info.target_distribution | tojson }};
    const targetPercentages = {{ preparation_info.target_distribution_percentages | tojson }};
    
    if (Object.keys(targetDistribution).length > 0) {
        const ctx = document.getElementById('targetDistributionChart').getContext('2d');
        
        const labels = Object.keys(targetDistribution);
        const counts = Object.values(targetDistribution);
        const percentages = Object.values(targetPercentages);
        
        // Colores dinámicos para las barras
        const colors = [
            '#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6f42c1', 
            '#fd7e14', '#20c997', '#e83e8c', '#6610f2', '#007bff'
        ];
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cantidad de casos',
                    data: counts,
                    backgroundColor: colors.slice(0, labels.length),
                    borderColor: colors.slice(0, labels.length),
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribución de la Variable Target',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        color: '#333'
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const percentage = percentages[context.dataIndex];
                                return `${context.parsed.y} casos (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: 'Número de casos'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Valores del Target'
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }
    {% endif %}

    
    // Generar gráfico interactivo de feature importance para clasificación
    {% if feature_importance %}
    const featureImportanceClass = {{ feature_importance | tojson }};
    
    if (Object.keys(featureImportanceClass).length > 0) {
        // Crear canvas para feature importance si no existe
        let importanceCanvasClass = document.getElementById('featureImportanceChartClass');
        if (!importanceCanvasClass) {
            // Buscar donde insertar el gráfico
            const importanceSection = document.querySelector('.model-section');
            if (importanceSection) {
                const chartDiv = document.createElement('div');
                chartDiv.innerHTML = `
                    <div class="info-card mt-4">
                        <h6>Importancia de Variables (Gráfico Interactivo)</h6>
                        <div class="chart-container" style="position: relative; height: 500px; margin-top: 20px;">
                            <canvas id="featureImportanceChartClass"></canvas>
                        </div>
                    </div>
                `;
                importanceSection.appendChild(chartDiv);
                importanceCanvasClass = document.getElementById('featureImportanceChartClass');
            }
        }
        
        if (importanceCanvasClass) {
            const ctx = importanceCanvasClass.getContext('2d');
            
            // Ordenar features por importancia
            const sortedFeaturesClass = Object.entries(featureImportanceClass)
                .sort(([,a], [,b]) => Math.abs(b) - Math.abs(a))
                .slice(0, 20); // Máximo 20 features
            
            const labels = sortedFeaturesClass.map(([name]) => name);
            const values = sortedFeaturesClass.map(([, value]) => Math.abs(value));
            
            // Colores degradados para clasificación
            const colors = values.map((_, index) => {
                const intensity = 1 - (index / values.length) * 0.5;
                return `rgba(40, 167, 69, ${intensity})`;
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Importancia',
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#28a745',
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false,
                    }]
                },
                options: {
                    indexAxis: 'y', // Barras horizontales
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Importancia de Variables en Clasificación',
                            font: { size: 16, weight: 'bold' },
                            color: '#333'
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `Variable: ${context[0].label}`;
                                },
                                label: function(context) {
                                    const originalValue = sortedFeaturesClass[context.dataIndex][1];
                                    return [
                                        `Importancia: ${originalValue.toFixed(6)}`,
                                        'Mayor valor = más importante para clasificar',
                                        'Ayuda a distinguir entre clases'
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Importancia de la Variable'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Variables Predictoras'
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
    }
    {% endif %}
});
</script>
{% endblock %}